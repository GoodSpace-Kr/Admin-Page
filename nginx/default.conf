# === 1) HTTP: 인증 경로만 허용, 나머지는 HTTPS로 리다이렉트 ===
server {
  listen 80;
  server_name goodspace.duckdns.org;

  # certbot webroot 인증 파일 경로
  location /.well-known/acme-challenge/ {
    root /var/www/certbot;
    allow all;
  }

  # 그 외 전부 HTTPS로 이동
  location / {
    return 301 https://$host$request_uri;
  }
}

# === 2) HTTPS: 실제 서비스 처리 ===
server {
  listen 443 ssl http2;
  server_name goodspace.duckdns.org;

  # --- 인증서 경로 (컨테이너 내부 경로) ---
  ssl_certificate     /etc/letsencrypt/live/goodspace.duckdns.org/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/goodspace.duckdns.org/privkey.pem;

  ssl_protocols TLSv1.2 TLSv1.3;
  ssl_ciphers HIGH:!aNULL:!MD5;

  # --- React 정적 서빙 ---
  root /usr/share/nginx/html;
  index index.html;
  client_max_body_size 50M;

  # SPA 라우팅
  location / {
    try_files $uri /index.html;
  }

  # --- API 프록시 ---
  location /api/ {
    rewrite ^/api/(.*)$ /$1 break;
    proxy_pass http://backend:8080;
    proxy_http_version 1.1;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_read_timeout 60s;
  }

  # 선택: 기본 압축
  gzip on;
  gzip_types text/plain text/css application/json application/javascript application/xml+rss application/xml application/octet-stream image/svg+xml;
}
